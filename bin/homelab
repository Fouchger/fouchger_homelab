#!/usr/bin/env bash
# -----------------------------------------------------------------------------
# Filename: bin/homelab
# Created: 2026-01-20
# Updated: 2026-01-20
# Description: fouchger_homelab interactive CLI entrypoint.
# Usage:
#   make menu
# Developer notes:
#   - Keep this as a thin orchestrator. Real logic sits in scripts/.
# -----------------------------------------------------------------------------

set -Eeuo pipefail
IFS=$'\n\t'

source "$(cd -- "$(dirname -- "${BASH_SOURCE[0]}")/.." && pwd -P)/lib/paths.sh"
source "${REPO_ROOT}/lib/logging.sh"
source "${REPO_ROOT}/lib/core.sh"
source "${REPO_ROOT}/lib/run.sh"
source "${REPO_ROOT}/lib/state.sh"
source "${REPO_ROOT}/lib/ui.sh"

run_init "menu"
state_init
ui_ensure_ui_deps

usage() {
  cat <<'EOF'
fouchger_homelab

Usage:
  bin/homelab                 Launch interactive menu
  bin/homelab dev-auth        Git and Github log in and authentication
  bin/homelab validate        Validate configuration
  bin/homelab bootstrap       Install prerequisites on this node
  bin/homelab plan            Terraform plan
  bin/homelab apply           Terraform apply then render inventory
  bin/homelab destroy         Terraform destroy
  bin/homelab ansible [--] .. Run Ansible (passes extra args through)
  bin/homelab healthcheck     Run end-to-end health checks
  bin/homelab lint            Run local quality gates
  bin/homelab test [mode]     Run test suite (mode: quick|infra|apply)
  bin/homelab settings        Launch questionnaires

Notes:
  - To opt out of validation: SKIP_VALIDATE=yes ...
EOF
}

if [[ "${1:-}" == "-h" || "${1:-}" == "--help" ]]; then
  usage
  exit 0
fi

# Non-interactive command mode (preferred for automation).
if [[ -n "${1:-}" ]]; then
  cmd="$1"; shift || true
  case "${cmd}" in
    dev-auth) scripts/core/dev-auth.sh ;;
    validate) scripts/core/validate.sh ;;
    bootstrap) scripts/core/bootstrap.sh ;;
    plan) scripts/proxmox/terraform.sh plan ;;
    apply) scripts/proxmox/terraform.sh apply ;;
    destroy) scripts/proxmox/terraform.sh destroy ;;
    ansible) scripts/core/ansible.sh "$@" ;;
    healthcheck) scripts/core/healthcheck.sh ;;
    lint) scripts/core/lint.sh ;;
    test) scripts/tests/run.sh "${1:-quick}" ;;
    settings) scripts/core/questionnaires.sh ;;
    *)
      error "Unknown command: ${cmd}"
      usage
      exit 2
      ;;
  esac
  exit 0
fi

# Ensure the terminal is restored if dialog is used.
cleanup_ui() { command -v dialog >/dev/null 2>&1 && clear || true; }
trap cleanup_ui EXIT

mikrotik_menu() {
  local choice
  while true; do
    ui_menu "MikroTik" "Backups, health checks, and DNS HA" choice \
      1 "ğŸ’¾ Backup MikroTik now" \
      2 "ğŸ©º Run health check now" \
      3 "ğŸŒ Configure DHCP to advertise dns01 + dns02" \
      4 "ğŸ§¾ Install start config locally" \
      5 "ğŸš€ Apply start config to MikroTik" \
      6 "â¬…ï¸ Back"

    case "${choice:-}" in
      1) scripts/mikrotik/backup.sh ;;
      2) scripts/mikrotik/healthcheck.sh ;;
      3) scripts/mikrotik/configure-dns.sh ;;
      4) scripts/mikrotik/install-start-config.sh ;;
      5) scripts/mikrotik/apply-start-config.sh ;;
      6|"") break ;;
    esac
  done
}

menu_main() {
  local choice
  while true; do
    ui_menu "homelab_2026.2" "Choose what you want to do" choice \
      1 "ğŸ§° Git and Github log in and authentication" \
      2 "ğŸ§° Bootstrap this node (prereqs)" \
      3 "ğŸ” Configure Proxmox API token" \
      4 "ğŸ“¦ Download Proxmox templates" \
      5 "ğŸ—ï¸  Provision or update VMs/LXCs (Terraform apply)" \
      6 "ğŸ§¯ Destroy VMs/LXCs (Terraform destroy)" \
      7 "ğŸ› ï¸  Configure services (Ansible)" \
      8 "ğŸ“¡ MikroTik integration" \
      9 "âš™ï¸  Settings and questionnaires" \
      10 "ğŸ“„ View logs folder" \
      99 "ğŸšª Exit"

    case "${choice:-}" in
      1) scripts/core/dev-auth.sh ;;
      2) scripts/core/bootstrap.sh ;;
      3) scripts/proxmox/bootstrap-api-token.sh ;;
      4) scripts/proxmox/templates.sh ;;
      5) scripts/proxmox/terraform.sh apply ;;
      6) scripts/proxmox/terraform.sh destroy ;;
      7) scripts/core/ansible.sh ;;
      8) mikrotik_menu ;;
      9) scripts/core/questionnaires.sh ;;
      10) ok "Logs live here: ${LOG_DIR_DEFAULT}" ;;
      99|"") break ;;
    esac
  done
}

menu_main