#!/usr/bin/env bash
# -----------------------------------------------------------------------------
# Filename: bin/homelab
# Created:  2026-01-20
# Updated:  2026-01-25
# Description: Interactive CLI entrypoint for fouchger_homelab.
#
# Layer 2 Session Capture
#   - Opt-in via FEATURE_SESSION_CAPTURE=1 in state.env.
#   - Uses Pentest-Terminal-Logger (ptlog) as-is.
#   - When enabled, we show ptlog status and a short tail of the current log.
#
# Notes:
#   - We do not run `ptlog tail` automatically because it blocks.
#   - If ptlog is missing, we continue without Layer 2.
# Maintainer: Gert
# -----------------------------------------------------------------------------

set -Eeuo pipefail
IFS=$'\n\t'

# Anchor off this file so the menu works even when the repo is installed
# without a .git directory.
REPO_ROOT="${REPO_ROOT:-$(cd -- "$(dirname -- "${BASH_SOURCE[0]}")/.." && pwd -P)}"
export REPO_ROOT

# shellcheck source=lib/modules.sh
source "${REPO_ROOT}/lib/modules.sh"
# shellcheck source=lib/state.sh
source "${REPO_ROOT}/lib/state.sh"
# shellcheck source=lib/features.sh
source "${REPO_ROOT}/lib/features.sh"

maybe_start_session_capture() {
  # Uses ptlog's default state directory (~/.ptlog/) and current.log symlink.
  # We treat ptlog as an external operator tool and avoid hard dependencies.
  if ! feature_enabled SESSION_CAPTURE; then
    return 0
  fi

  if ! command -v ptlog >/dev/null 2>&1; then
    echo "[WARN] Session capture enabled but 'ptlog' not found in PATH. Continuing without Layer 2." >&2
    echo "       Install ptlog from supasuge/Pentest-Terminal-Logger." >&2
    return 0
  fi

  local pid_file="${HOME}/.ptlog/ptlog.pid"
  local current_log="${HOME}/.ptlog/current.log"

  # Start capture if not already active.
  if [[ -f "$pid_file" ]]; then
    local pid
    pid="$(cat "$pid_file" 2>/dev/null || true)"
    if [[ -n "$pid" ]] && kill -0 "$pid" 2>/dev/null; then
      echo "[INFO] Layer 2 session capture already active (ptlog pid ${pid})."
    else
      ptlog start >/dev/null 2>&1 || true
    fi
  else
    ptlog start >/dev/null 2>&1 || true
  fi

  echo "[INFO] Layer 2 session capture: ENABLED"
  ptlog status 2>/dev/null || true

  # Provide quick visibility without blocking.
  if [[ -f "$current_log" ]]; then
    echo "[INFO] Layer 2 tail (last 20 lines): ${current_log}"
    tail -n 20 "$current_log" 2>/dev/null || true
  fi
}

maybe_start_session_capture

homelab_load_lib
homelab_load_modules

main_menu
